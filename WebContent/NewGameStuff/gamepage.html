<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="imageEditing.css" />
    <link rel="stylesheet" href="gameLobby.css" />
    <link rel="stylesheet" href="endGame.css" />
    <link rel="stylesheet" href="gameTimeout.css" />
    <title>Game Page</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
        }

        body {
            background-image: url("background1.jpeg");
        }

        .window-container {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <!--LOBBY CONTAINER-->
    <div class="window-container" id="lobby" style="display: none;">
    	<h3 id="roomcode-display"></h3>
        <div id="lobby-container">
            <!--<div class="player-card" id="">
                <h3 class="player-status">Host</h3>
                <h1 class="player-card-name">Yo Mamma</h1>
            </div>-->
        </div>
    </div>

    <!--EDITING CONTAINER (PLAYER) -->
    <div class="window-container" id="image-editing" style="display: none;">
        <div class="image-workspace">
            <div class="image-container">
                <img class="image" id="loaded_image" src="" />
                <div class="image-fields">
                    <div id="header" onclick="setCurrentImageField('header');">Header</div>
                    <div id="top" onclick="setCurrentImageField('top');">Top</div>
                    <div id="middle" onclick="setCurrentImageField('middle');">Middle</div>
                    <div id="bottom" onclick="setCurrentImageField('bottom');">Bottom</div>
                    <div id="footer" onclick="setCurrentImageField('footer');">Footer</div>
                </div>

            </div>
            <div class="side-panel">
                <h1 id="panel-title">Editor <span id="panel-title-field"></span></h1>
                <div class="editor-option">
                    <div class="dropdown">
                        <button class="btn btn-secondary btn-lg dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            X-Align <div class="caret"></div>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item" href="#" onclick="editChangeXAlign('left');">Left</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editChangeXAlign('right');">Right</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editChangeXAlign('center');">Center</a></li>
                        </ul>
                    </div>
                </div>
                <div class="editor-option">
                    <div class="dropdown">
                        <button class="btn btn-secondary btn-lg dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Size <div class="caret"></div>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontSize(12);">Small</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontSize(18);">Medium</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontSize(24);">Large</a></li>
                        </ul>
                    </div>
                </div>
                <div class="editor-option">
                    <div class="dropdown">
                        <button class="btn btn-secondary btn-lg dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Outline Size <div class="caret"></div>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontOutline(0);">None</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontOutline(0.5);">Light</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontOutline(1);">Regular</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontOutline(2);">Thick</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontOutline(3);">Thiccccc</a></li>

                        </ul>
                    </div>
                </div>
                <div class="editor-option">
                    <div class="dropdown">
                        <button class="btn btn-secondary btn-lg dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Font <div class="caret"></div>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontFamily('helvetica');">Helvetica</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontFamily('times');">Times New Roman</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontFamily('papyrus');">Papyrus</a></li>
                        </ul>
                    </div>
                </div>
                <div class="editor-option">
                    <div class="dropdown">
                        <button class="btn btn-secondary btn-lg dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Style <div class="caret"></div>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontStyle('plain');">Plain</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontStyle('bold');">Bold</a></li>
                            <li><a class="dropdown-item" href="#" onclick="editChangeFontStyle('italic');">Italic</a></li>
                        </ul>
                    </div>
                </div>
                <div class="editor-option editor-text">
                    <label for="input-text" style="font-size : 16pt; margin-right : 8px;">Text</label>
                    <input type="text" id="input-text" onblur="changeTextField();" />
                </div>
            </div>
        </div>
    </div>
    
     <!--EDITING CONTAINER (JUDGE) -->
    <div class="window-container" id="image-editing-judge" style="display: none;">
    	<h1>You are the Judge this round.</h1>
    </div>

    <!--TIMEOUT CONTAINER (PLAYER)-->
    <div class="window-container" id="timeout-player" style="display: none;">
        <div id="judge-container">
            <div id="timeout-content-window">
                <h1 id="judge-content-title">Waiting for judge...</h1>
                <img class="timeout-img" src="background1.jpeg" />
            </div>
        </div>
    </div>

    <!--TIMEOUT CONTAINER (JUDGE)-->
    <div class="window-container" id="timeout-judge" style="display:none;">
        <div id="judge-container">
            <div id="judge-content-window">
                <h1 id="judge-content-title">Pick a Winner</h1>
                <img class="judge-img" src="background1.jpeg" />
                <img class="judge-img" src="background1.jpeg" />
                <img class="judge-img" src="background1.jpeg" />
                <img class="judge-img" src="background1.jpeg" />
                <img class="judge-img" src="background1.jpeg" />
                <img class="judge-img" src="background1.jpeg" />

            </div>
            <button class="btn" id="choose-winner-button" onclick="sendWinner();">Choose Winner</button>
        </div>
    </div>
    
    <!--JUDGE'S PICK CONTAINER-->
    <div class="window-container" id="show-winner" style="display:none;">
        <div id="playerContainer" style="width:80%;margin-left:auto;margin-right:auto;justify-content: center;text-align:center;">
            <h3>The Winner : </h3>
            <h1 id="winnerID"></h1>
        </div>
    </div>

    <!--END OF GAME CONTAINER-->
    <div class="window-container" id="end-of-game" style="display: none;">
        <div class="end-of-game-container">
            <h1>Game Over</h1>
            <button class="btn" id="end-game-return-button" onclick="returnHome();">Return Home</button>
        </div>
    </div>

    <script type="text/javascript">//Long Poll

        let gameEnd = false;

        // ALL POSSIBLE GAME WINDOWS
        
        /*
        const lobbyWindow = document.getElementById("lobby");
        const editingWindow = document.getElementById("image-editing");
        const endGameWindow = document.getElementById("end-of-game");
        */

        const event = {
            LOBBY: "JOIN",
            START: "START",
            JUDGE: "JUDGE",
            TIMEOUT: "TIMEOUT",
            END: "END"
        };

        function callLongPoll() {

            const windows = {
                LOBBYWINDOW: document.getElementById("lobby"),
                EDITWINDOW: document.getElementById("image-editing"),
                EDITWINDOW_JUDGE: document.getElementById("image-editing-judge"),
                ENDWINDOW: document.getElementById("end-of-game"),
                JUDGEWINDOW: document.getElementById("show-winner"),
                TIMEOUTWINDOW_PLAYER: document.getElementById("timeout-player"),
                TIMEOUTWINDOW_JUDGE: document.getElementById("timeout-judge")
            };

            console.log("Waiting for long poll...");

            $.ajax({
                url: "../LongPollServlet",
                method: "GET",
                data: null,
                success: function (result) {

                    let windowArray = [
                        document.getElementById("lobby"),
                        document.getElementById("image-editing"),
                        document.getElementById("image-editing-judge"),
                        document.getElementById("timeout-player"),
                        document.getElementById("timeout-judge"),
                        document.getElementById("show-winner"),
                        document.getElementById("end-of-game")
                    ];

                    // HIDE ALL DISPLAYS
                    for (let i = 0; i < windowArray.length; i++) {
                        let view = windowArray[i];
                        view.style.display = 'none';
                    }


                    var respObj = JSON.parse(result);
                    var eventType = respObj.event;

                    console.log("Recieved event: " + eventType);
                    console.log("Recieved event object: " + result);

                    switch (eventType) {
                        case event.LOBBY:
                            windows.LOBBYWINDOW.style.display = 'block';
                            displayLobby(respObj);
                            break;
                        case event.START:
                        	var isJudge = respObj.judge;
                        	if(isJudge){
                        		windows.EDITWINDOW_JUDGE.style.display = 'block';
                        	} else {
                        		windows.EDITWINDOW.style.display = 'block';
                                displayStart(respObj);
                        	}
                            break;
                        case event.JUDGE:
                            windows.JUDGEWINDOW.style.display = 'block';
                            displayWinningImage(respObj);
                            break;
                        case event.TIMEOUT:
                            var isJudge = respObj.judge; // Bool returned from long poll
                            if (isJudge) {
                                windows.TIMEOUTWINDOW_JUDGE.style.display = 'block';
                                displayJudgeTimeout(respObj);
                            }
                            else {
                                windows.TIMEOUTWINDOW_PLAYER.style.display = 'block';
                                displayPlayerTimeout(respObj);
                            }
                            break;
                        case event.END:
                            windows.ENDWINDOW.style.display = 'block';
                            endGame();
                            gameEnd = true;
                            break;
                        default:
                            break;
                    }

                    if (!gameEnd) {
                        callLongPoll();
                    }
                }
            });
        }

        
            

        function whateverYouWantToNameIt() {
            callLongPoll();
        }
        </script>

    <script>
        // PURGING ALL CONTENTS FROM PREVIOUS ROUND
        function cleanInside(parent) {
            while (parent.firstChild) {
                parent.removeChild(parent.firstChild);
            }
        }
    </script>

    <!--Servlet Functions-->
    <script>

        // LOBBY
        function displayLobby(respObj_) {
        	
        	document.getElementById("roomcode-display").innerHTML = "Room code: " + respObj_.code;

            var playerObjList = respObj_.players;
            console.log("Player List: " + playerObjList);
            const lobbyContainer = document.getElementById("lobby-container");
            
            cleanInside(lobbyContainer);

            for (i in playerObjList) {
            	let player = playerObjList[i];
                // Make new player card 
                var playercard = document.createElement("div");
                playercard.setAttribute("class", "player-card");

                var playerCardName = document.createElement("h1");
                playerCardName.setAttribute("class", "player-card-name");

                var playerCardStatus = document.createElement("h3");
                playerCardStatus.setAttribute("class", "player-status");

                playerCardName.innerHTML = player;  // player username
                
                var playerStatus = "player";
                playerCardStatus.innerHTML = playerStatus;

                playercard.appendChild(playerCardStatus);
                playercard.appendChild(playerCardName);
                lobbyContainer.appendChild(playercard);
            }
        }

        //EDITING 
        function displayStart(respObj_) {
            var currImg = "data:image/png;base64," + respObj_.image;   // extract current image
            const imageContainer = document.getElementById("loaded_image");
            imageContainer.setAttribute("src", currImg);
        }

        // JUDGING WINDOW (JUDGE)--> DISPLAY WINDOW

        function displayJudgeTimeout(respObj_) {
            var images = respObj_.images;
            const timeoutJudgeContainer = document.getElementById("judge-content-window");
            // PURGE INSIDE FROM PREVIOUS ROUNDS 
            cleanInside(timeoutJudgeContainer);
            // FILL WITH NEW CONTENTS
            var i = 0;
            for (image in images) {
                var judgeImg = document.createElement("img");
                judgeImg.setAttribute("class", "judge-img");
                
                let currImg = "data:image/png;base64," + images[image];
                judgeImg.setAttribute("src", currImg);
                $(judgeImg).data('data-imgId', i);
                
                timeoutJudgeContainer.appendChild(judgeImg);
                i++;
            }
            
            // Adding event listener
            $('.judge-img').click(function () {
                console.log("Image clicked");
                if ($(this)[0].hasAttribute("id")) {
                    $(this).removeAttr('id');
                    imageSelected = false;
                }

                else if (!imageSelected) {
                    imageSelected = true;
                    $(this).attr('id', 'judge-img-selected'); // removes the previous selected class 
                    selectedImgId = $(this).data('data-imgId');
                }
            });

        }

        // JUDGING WINDOW (JUDGE)--> WINNER SELECTION  
        let imageSelected = false;
       	var selectedImgId;
        
        // ON SUBMIT BUTTON CLICK
        function sendWinner() {
        	if(selectedImgId != null){
        		$.ajax({
            		url : "../JudgeImageServlet",
            		data : {
            			winner : selectedImgId
            		}
            	});
        	} else {
        		alert("NO IMAGE SELECTED!");
        	}
        	
        }

        //JUDGING WINDOW (PLAYER)
        function displayPlayerTimeout(respObj_) {
            var images = respObj_.images;
            const timeoutJudgeContainer = document.getElementById("timeout-content-window");
            // PURGE INSIDE FROM PREVIOUS ROUNDS 
            cleanInside(timeoutJudgeContainer);
            // FILL WITH NEW CONTENTS 
            for (image in images) {
                var playerImg = document.createElement("img");
                playerImg.setAttribute("class", "timeout-img");
                let currImg = "data:image/png;base64," + images[image];
                playerImg.setAttribute("src", currImg);
                timeoutJudgeContainer.appendChild(playerImg);
            }
        }

        // SHOW WINNER
        function displayWinningImage(respObj_) {
            const winnerContainer = document.getElementById("playerContainer");
            // PURGE INSIDE FROM PREVIOUS ROUNDS
            cleanInside(winnerContainer);
            // FILL WITH NEW CONTENTS 
            var winningImg = "data:image/png;base64," + respObj_.image;
            var addImg = document.createElement("img");
            addImg.setAttribut('src', winningImg);
        }

        // END GAME 
        function endGame() {
            console.log("GAME ENDED!");
        }
    </script>

    <script type="text/javascript">
        const editor_panel_title = document.getElementById('panel-title-field');
        let FIELD = 'none';

        // send to PreviewMemeServlet
        // Defaults: 
        let previewMemeJson = {
            alignmentY: 'TOP',
            alignmentX: 'CENTER',
            size: 12,
            outlineSize: 1.0,
            fillColor: 'BLACK',
            outlineColor: 'BLACK',
            headerBGColor: 'WHITE',
            footerBGColor: 'WHITE',
            font: 'Helvetica Neue',
            fontStyle: 'plain',
            text: ''

        };

        function PreviewMemeServlet() {
            $.ajax({
                type: 'POST',
                url: "../PreviewMemeServlet",
                data: previewMemeJson,
                success: function (result) {
                    let resultObj = JSON.parse(result);
                    let b64Image = resultObj.image;
                    let dataURL = "data:image/png;base64," + b64Image;
                    $("#loaded_image").attr("src", dataURL);
                }
            });
        }

        function setCurrentImageField(element_id) {
            switch (element_id) {
                case 'header':
                    FIELD = 'HEAD';
                    break;
                case 'top':
                    FIELD = 'TOP';
                    break;
                case 'middle':
                    FIELD = 'MID';
                    break;
                case 'bottom':
                    FIELD = 'LOW';
                    break;
                case 'footer':
                    FIELD = 'FOOT';
                    break;
                default:
                    FIELD = 'none';
                    break;
            }
            previewMemeJson.alignmentY = FIELD;
            PreviewMemeServlet();
        }

        function changeTextField() {
            var inner_text = document.getElementById('input-text').value;
            previewMemeJson.text = inner_text;
            PreviewMemeServlet();
        }

        function editChangeFontSize(sizeClass) {
            previewMemeJson.size = sizeClass;
            PreviewMemeServlet();
        }

        function editChangeXAlign(alignClass) {
            previewMemeJson.alignmentX = alignClass;
            PreviewMemeServlet();
        }

        function editChangeFontFamily(fontSize) {
            previewMemeJson.font = fontSize;
            PreviewMemeServlet();
        }

        function editChangeFontStyle(styleClass) {
            previewMemeJson.fontStyle = styleClass;
            PreviewMemeServlet();
        }

        function editChangeFontOutline(outlineSize) {
            previewMemeJson.outlineSize = outlineSize;
            PreviewMemeServlet();
        }
        </script>
</body>
<script type="text/javascript">
whateverYouWantToNameIt();
</script>

</html>
